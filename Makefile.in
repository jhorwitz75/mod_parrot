# $Id: Makefile.in 613 2009-02-21 15:54:38Z jhorwitz $

# This file is autogenerated.  Changes will be lost after reconfiguration.

CC=@CC@
LIBTOOL=@LIBTOOL@
APR_INCLUDE_DIR=@APR_INCLUDE_DIR@
APU_INCLUDE_DIR=@APU_INCLUDE_DIR@
DEFINES=@DEFINES@
CFLAGS=@CFLAGS@
DEBUG=@DEBUG@
EXTRA_CPPFLAGS=@EXTRA_CPPFLAGS@
LDFLAGS=@LDFLAGS@
LIBS=@LIBS@
LIBEXECDIR=@LIBEXECDIR@
PERL=@PERL@
APXS=@APXS@
PARROT_SOURCE=@PARROT_SOURCE@
PARROT_BLIB_DIR=@PARROT_BLIB_DIR@
PARROT=@PARROT@
APACHE_INCLUDE_DIR=@APACHE_INCLUDE_DIR@
PARROT_DYNEXT=$(PARROT_SOURCE)/runtime/parrot/dynext
BUILD_DYNPMC=$(PERL) $(PARROT_SOURCE)/tools/build/dynpmc.pl
MODPARROT_GROUP=modparrot_group.so
export DYNPMC_INCLUDE=$(APACHE_INCLUDE_DIR),$(APR_INCLUDE_DIR),$(APU_INCLUDE_DIR),../../include

SRC_DIR = src
TEST_SRC_DIR = t/src

SOURCE_FILES= \
	$(SRC_DIR)/mod_parrot.c \
	$(SRC_DIR)/parrot_util.c \
	$(SRC_DIR)/modparrot_config.c \
	$(SRC_DIR)/nci.c \
	$(SRC_DIR)/context.c \
	$(SRC_DIR)/modparrot_io.c \
	$(SRC_DIR)/module.c

OBJ_FILES= \
	$(SRC_DIR)/mod_parrot.lo \
	$(SRC_DIR)/parrot_util.lo \
	$(SRC_DIR)/modparrot_config.lo \
	$(SRC_DIR)/nci.lo \
	$(SRC_DIR)/context.lo \
        $(SRC_DIR)/modparrot_io.lo \
	$(SRC_DIR)/module.lo

MPLIBS=	lib/ModParrot/Apache/RequestRec.pbc \
	lib/ModParrot/Apache/ServerRec.pbc \
	lib/ModParrot/Apache/Constants.pbc \
	lib/ModParrot/Apache/Module.pbc \
	lib/ModParrot/Apache/CmdParms.pbc \
	lib/ModParrot/APR/Pool.pbc \
	lib/ModParrot/APR/Table.pbc \
	lib/mod_parrot.pbc \
	lib/ModParrot/Constants.pbc \
	lib/ModParrot/Context.pbc \
	lib/ModParrot/Interpreter.pbc \
	lib/ModParrot/HLL/pir.pbc \
	lib/ModParrot/HLL/perl6.pbc \
	lib/ModParrot/HLL/pipp.pbc \
	lib/ModParrot/HLL/lolcode.pbc

PMCS= modparrothandle

PMC_SOURCES= $(SRC_DIR)/pmc/modparrothandle.pmc

all: gen-src $(SRC_DIR)/mod_parrot.la libs $(MODPARROT_GROUP)

%.lo: %.c
	$(LIBTOOL) --mode=compile $(CC) -o $@ $(EXTRA_CPPFLAGS) $(DEBUG) $(CFLAGS) -I$(APACHE_INCLUDE_DIR) -I$(APR_INCLUDE_DIR) -I$(APU_INCLUDE_DIR) $(DEFINES) -c $<

$(SRC_DIR)/mod_parrot.la: $(OBJ_FILES)
	$(LIBTOOL) --mode=link $(CC) -o $@ $(LDFLAGS) $(OBJ_FILES) $(LIBS) -rpath $(LIBEXECDIR) -module -avoid-version

files-clean:
	rm -f $(SRC_DIR)/*.o $(SRC_DIR)/*.lo $(SRC_DIR)/*.slo $(SRC_DIR)/*.la core core.*
	rm -rf $(SRC_DIR)/.libs

%.pbc: %.pir
	$(PARROT) -o $@ $<

libs: $(MPLIBS)

$(MODPARROT_GROUP): $(PMC_SOURCES)
	cd $(SRC_DIR)/pmc && $(BUILD_DYNPMC) generate $(PMCS)
	cd $(SRC_DIR)/pmc && $(BUILD_DYNPMC) compile $(PMCS)
	cd $(SRC_DIR)/pmc && $(BUILD_DYNPMC) linklibs $(PMCS)

modperl6: languages/perl6/lib/mod_perl6.pir languages/perl6/lib/ModPerl6/Registry.pir

%.pir: %.pm
	PERL6LIB=languages/perl6/lib \
	$(PARROT) $(PARROT_SOURCE)/languages/rakudo/perl6.pbc \
	--output=$@ --target=pir $<

modperl6-clean:
	rm -f languages/perl6/lib/mod_perl6.pir \
	languages/perl6/lib/ModPerl6/Registry.pir

gen-src:
	@echo Generating Source...
	perl build/lib/generate_source.pl --apache-include-dir=$(APACHE_INCLUDE_DIR)

gen-src-clean:
	rm -rf build/src

libs-clean: 
	rm -f $(MPLIBS)

pmcs-clean:
	rm -f $(SRC_DIR)/pmc/$(MODPARROT_GROUP)
	rm -f $(SRC_DIR)/pmc/*.c
	rm -f $(SRC_DIR)/pmc/*.h
	rm -f $(SRC_DIR)/pmc/*.o
	rm -f $(SRC_DIR)/pmc/*.dump
	rm -f $(SRC_DIR)/pmc/*.exp

test-clean:
	if [ -x t/TEST ]; then t/TEST -clean; fi
	rm -f t/core.* t/lib/handlers.pbc t/TEST

clean: files-clean libs-clean pmcs-clean gen-src-clean modperl6-clean

distclean: clean test-clean
	rm -f Makefile Makefile.old

install: $(SRC_DIR)/mod_parrot.la $(MODPARROT_GROUP)
	$(APXS) -i -n parrot -a $(SRC_DIR)/mod_parrot.la
	cd $(SRC_DIR)/pmc && $(BUILD_DYNPMC) copy "--destination=$(PARROT_DYNEXT)" $(PMCS)

test: $(SRC_DIR)/mod_parrot.la libs
	$(PARROT) -o t/lib/handlers.pbc t/lib/handlers.pir
	$(PERL) t/TEST
